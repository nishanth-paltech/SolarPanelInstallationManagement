@{
    ViewData["Title"] = "Consumer Survey";
}

<div class="container-fluid mt-3">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Consumer Survey</h4>

        <div class="d-flex gap-2">
            <!-- Column Picker -->
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown">
                    Columns
                </button>
                <ul class="dropdown-menu p-3" id="columnToggleMenu"></ul>
            </div>

           @*  <!-- Add -->
            <button class="btn btn-primary" onclick="openAddEditModal()">
                Add New
            </button> *@
        </div>
    </div>

    <!-- TABLE (ONLY CRITICAL COLUMNS IN HTML) -->
    <table id="consumerSurveyTable"
           class="table table-bordered table-striped table-hover w-100">
    </table>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal fade" id="addEditModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" id="addEditModalContent">
            <!-- loaded dynamically -->
        </div>
    </div>
</div>

@section Scripts {

    <script>
        var table;
        let currentSurveySno = null;

        $(document).ready(function () {

            table = $('#consumerSurveyTable').DataTable({
                processing: true,
                serverSide: true,
                stateSave: true,
                autoWidth: false,
                responsive: false,
                scrollX: true,
                ajax: {
                    url: '@Url.Action("GetData", "ConsumerSurvey")',
                    type: 'POST'
                },

                        columns: [
            { data: 'sno', title: 'S.No', visible: true },
            { data: 'district', title: 'District', visible: true },
            { data: 'mandal', title: 'Mandal', visible: true },
            { data: 'village', title: 'Village', visible: true },
            { data: 'consumerNameWithSurname', title: 'Consumer Name', visible: true },
            { data: 'serviceNumber', title: 'Service No', visible: true },
            { data: 'consumerMobileNo', title: 'Mobile', visible: true },
            { data: 'feederName', title: 'Feeder Name', visible: true },
            { data: 'category', title: 'Category', visible: true },

            // hidden but selectable
            { data: 'constituency', title: 'Constituency', visible: false },
            { data: 'uscno', title: 'USC No', visible: false },
            { data: 'existingContractedLoadKW', title: 'Load (KW)', visible: false },
            { data: 'hasOtherDomesticServices', title: 'Other Services', visible: false },
            { data: 'aadharNo', title: 'Aadhar', visible: false },
            { data: 'isBeneficiaryUnderGJScheme', title: 'GJ Scheme', visible: false },
            { data: 'latitudeLongitude', title: 'Lat / Long', visible: false },
            { data: 'typeOfRoof', title: 'Roof Type', visible: false },
            { data: 'shadeFreeRoofAreaSqFt', title: 'Roof Area', visible: false },
            { data: 'remarks', title: 'Remarks', visible: false },
            { data: 'isNameChangeRequired', title: 'Name Change', visible: false },
            { data: 'ssName', title: 'SS Name', visible: false },
            { data: 'poleNumber', title: 'Pole No', visible: false },
            { data: 'dtrStructureCode', title: 'DTR Code', visible: false },
            { data: 'existingDtrCapacityKva', title: 'DTR Capacity', visible: false },

            {
                data: null,
                title: 'Actions',
                orderable: false,
                searchable: false,
                render: function (data, type, row) {
                    // return `
                    //     <button class="btn btn-sm btn-warning me-1"
                    //             onclick="openAddEditModal(${row.sno})">Edit</button>
                    //     <button class="btn btn-sm btn-danger"
                    //             onclick="deleteRecord(${row.sno})">Delete</button>
                    // `;
                    return `
                        <button class="btn btn-sm btn-warning me-1"
                                onclick="openAddEditModal(${row.sno})">Start Survey</button>
                    `;
                }
            }
        ]

            });

            // ===== BUILD COLUMN PICKER =====
            table.columns().every(function (index) {
                var column = this;
                var title = column.settings()[0].aoColumns[index].sTitle;

                if (title === 'Actions') return;

                $('#columnToggleMenu').append(`
                    <li>
                        <div class="form-check">
                            <input class="form-check-input column-toggle"
                                   type="checkbox"
                                   ${column.visible() ? 'checked' : ''}
                                   data-column="${index}">
                            <label class="form-check-label">${title}</label>
                        </div>
                    </li>
                `);
            });

            // Toggle visibility
            $(document).on('change', '.column-toggle', function () {
                var index = $(this).data('column');
                var column = table.column(index);
                column.visible(!column.visible());
            });
        });

        // ===== ADD / EDIT MODAL =====
        function openAddEditModal(id) {
            var url = '/ConsumerSurvey/AddEdit';
            if (id) url += '?id=' + id;

            $('#addEditModalContent').load(url, function () {

                var modal = new bootstrap.Modal(
                    document.getElementById('addEditModal')
                );
                modal.show();

                // 🔥 THIS IS CRITICAL
                if (id) {
                    currentSurveySno = id;
                    loadAttachments(id);
                }
            });
        }

        // Submit Add/Edit
        $(document).on('submit', '#addEditForm', function (e) {
            e.preventDefault();

            var form = $(this);

            $.post(form.attr('action'), form.serialize(), function (res) {
                if (res.success) {
                    bootstrap.Modal.getInstance(
                        document.getElementById('addEditModal')
                    ).hide();

                    table.ajax.reload(null, false);
                } else {
                    $('#addEditModalContent').html(res);
                }
            });
        });

        function uploadAttachments() {

            var surveySno = $('#surveySno').val();
            var filesInput = document.getElementById('attachmentFiles');

            if (!filesInput.files.length) {
                alert('Please select files');
                return;
            }

            var formData = new FormData();
            formData.append('surveySno', surveySno);

            for (let i = 0; i < filesInput.files.length; i++) {
                formData.append('files', filesInput.files[i]);
            }

            var progressContainer = $('#uploadProgress');
            var progressBar = $('#uploadProgress .progress-bar');

            progressBar.css('width', '0%').text('0%');
            progressContainer.removeClass('d-none');

            var xhr = new XMLHttpRequest();

            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    var percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.css('width', percent + '%').text(percent + '%');
                }
            };

            xhr.onload = function () {
                progressContainer.addClass('d-none');

                if (xhr.status === 200) {
                    $('#attachmentFiles').val('');
                    $('#imagePreviewContainer').empty();
                    loadAttachments(surveySno);
                } else {
                    alert(xhr.responseText || 'Upload failed');
                }
            };

            xhr.onerror = function () {
                progressContainer.addClass('d-none');
                alert('Upload failed');
            };

            xhr.open('POST', '/ConsumerSurveyAttachment/Upload', true);

            xhr.setRequestHeader(
                'RequestVerificationToken',
                $('input[name="__RequestVerificationToken"]').val()
            );

            xhr.send(formData);
        }

        // Inline image preview before upload
        $(document).on('change', '#attachmentFiles', function () {

            var previewContainer = $('#imagePreviewContainer');
            previewContainer.empty();

            var files = this.files;

            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {

                if (!file.type.startsWith('image/')) return;

                var imgUrl = URL.createObjectURL(file);

                var html = `
                    <div class="col-md-3">
                        <img src="${imgUrl}"
                             class="img-thumbnail"
                             style="height:120px; object-fit:cover;" />
                    </div>
                `;

                previewContainer.append(html);
            });
        });

        // Delete
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            $.post('/ConsumerSurvey/Delete/' + id, function () {
                table.ajax.reload(null, false);
            });
        }

        function loadAttachments(surveySno) {
            $('#attachmentsContainer').load(
                '/ConsumerSurveyAttachment/List/' + surveySno
            );
        }

        // $(document).on('submit', '#attachmentUploadForm', function (e) {
        //     e.preventDefault();

        //     var form = this;
        //     var formData = new FormData(form);
        //     var progressContainer = $('#uploadProgress');
        //     var progressBar = $('#uploadProgress .progress-bar');

        //     progressBar.css('width', '0%').text('0%');
        //     progressContainer.removeClass('d-none');

        //     var xhr = new XMLHttpRequest();

        //     xhr.upload.onprogress = function (e) {
        //         if (e.lengthComputable) {
        //             var percent = Math.round((e.loaded / e.total) * 100);
        //             progressBar.css('width', percent + '%')
        //                 .text(percent + '%');
        //         }
        //     };

        //     xhr.onload = function () {
        //         progressContainer.addClass('d-none');

        //         if (xhr.status === 200) {
        //             var surveySno = formData.get('surveySno');

        //             // Reset file input + preview
        //             $('#attachmentFiles').val('');
        //             $('#imagePreviewContainer').empty();

        //             loadAttachments(surveySno);
        //         } else {
        //             alert(xhr.responseText || 'Upload failed.');
        //         }
        //     };

        //     xhr.onerror = function () {
        //         progressContainer.addClass('d-none');
        //         alert('Upload failed.');
        //     };

        //     xhr.open('POST', '/ConsumerSurveyAttachment/Upload', true);

        //     // Anti-forgery token
        //     xhr.setRequestHeader(
        //         'RequestVerificationToken',
        //         $('input[name="__RequestVerificationToken"]').val()
        //     );

        //     xhr.send(formData);
        // });


        // Delete attachment
        function deleteAttachment(id, name) {
            const displayName = name || 'this file';

            if (!confirm(`Are you sure you want to delete "${displayName}"?`)) {
                return;
            }
            $.ajax({
                url: '/ConsumerSurveyAttachment/Delete/' + id,
                type: 'POST',
                headers: {
                    'RequestVerificationToken':
                        $('input[name="__RequestVerificationToken"]').val()
                },
                success: function () {
                    // Reset file input + preview
                    $('#attachmentFiles').val('');
                    $('#imagePreviewContainer').empty();
                    // Reload list
                    loadAttachments(currentSurveySno);
                }
            });
        }
    </script>
}